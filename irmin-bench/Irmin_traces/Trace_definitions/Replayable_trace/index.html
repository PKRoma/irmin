<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Replayable_trace (irmin-bench.Irmin_traces.Trace_definitions.Replayable_trace)</title><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">irmin-bench</a> &#x00BB; <a href="../../index.html">Irmin_traces</a> &#x00BB; <a href="../index.html">Trace_definitions</a> &#x00BB; Replayable_trace</nav><header class="odoc-preamble"><h1>Module <code><span>Trace_definitions.Replayable_trace</span></code></h1><p><code>Replayable_trace</code>, a trace of Tezos's interactions with Irmin.</p></header><nav class="odoc-toc"><ul><li><a href="#interleaved-contexts-and-commits">Interleaved Contexts and Commits</a></li></ul></nav><div class="odoc-content"><h4 id="interleaved-contexts-and-commits"><a href="#interleaved-contexts-and-commits" class="anchor"></a>Interleaved Contexts and Commits</h4><p>All the recorded operations in Tezos operate on (and create new) immutable records of type <code>context</code>. Most of the time, everything is linear (i.e. the input context to an operation is the latest output context), but there sometimes are several parallel chains of contexts, where all but one will end up being discarded.</p><p>Similarly to contexts, commits are not always linear, i.e. a checkout may choose a parent that is not the latest commit.</p><p>To solve this conundrum when replaying the trace, we need to remember all the <code>context_id -&gt; tree</code> and <code>trace commit hash -&gt; real commit hash</code> pairs to make sure an operation is operating on the right parent.</p><p>In the trace, the context indices and the commit hashes are 'scoped', meaning that they are tagged with a boolean information indicating if this is the very last occurence of that value in the trace. This way we can discard a recorded pair as soon as possible.</p><p>In practice, there is only 1 context and 1 commit in history, and sometimes 0 or 2, but the code is ready for more.</p><div class="odoc-spec"><div class="spec module anchored" id="module-V0"><a href="#module-V0" class="anchor"></a><code><span><span class="keyword">module</span> <a href="V0/index.html">V0</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Latest"><a href="#module-Latest" class="anchor"></a><code><span><span class="keyword">module</span> Latest</span><span> = <a href="V0/index.html">V0</a></span></code></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="V0/index.html">Latest</a> <span class="keyword">end</span></span></code></summary><div class="odoc-spec"><div class="spec value anchored" id="val-version"><a href="#val-version" class="anchor"></a><code><span><span class="keyword">val</span> version : int</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-header"><a href="#type-header" class="anchor"></a><code><span><span class="keyword">type</span> header</span><span> = unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-header_t"><a href="#val-header_t" class="anchor"></a><code><span><span class="keyword">val</span> header_t : <span>unit <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-scope"><a href="#type-scope" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a scope</span></span><span> = <span><span class="type-var">'a</span> <a href="V0/index.html#type-scope">V0.scope</a></span></span><span> = </span></code><ol><li id="type-scope.Forget" class="def variant constructor anchored"><a href="#type-scope.Forget" class="anchor"></a><code><span>| </span><span><span class="constructor">Forget</span> <span class="keyword">of</span> <span class="type-var">'a</span></span></code></li><li id="type-scope.Keep" class="def variant constructor anchored"><a href="#type-scope.Keep" class="anchor"></a><code><span>| </span><span><span class="constructor">Keep</span> <span class="keyword">of</span> <span class="type-var">'a</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-scope_t"><a href="#val-scope_t" class="anchor"></a><code><span><span class="keyword">val</span> scope_t : <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Repr</span>.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-scope">scope</a></span> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-key"><a href="#type-key" class="anchor"></a><code><span><span class="keyword">type</span> key</span><span> = <span>string list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-key_t"><a href="#val-key_t" class="anchor"></a><code><span><span class="keyword">val</span> key_t : <span><span>string list</span> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-hash"><a href="#type-hash" class="anchor"></a><code><span><span class="keyword">type</span> hash</span><span> = string</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash_t"><a href="#val-hash_t" class="anchor"></a><code><span><span class="keyword">val</span> hash_t : <span>string <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-message"><a href="#type-message" class="anchor"></a><code><span><span class="keyword">type</span> message</span><span> = string</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-message_t"><a href="#val-message_t" class="anchor"></a><code><span><span class="keyword">val</span> message_t : <span>string <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-context_id"><a href="#type-context_id" class="anchor"></a><code><span><span class="keyword">type</span> context_id</span><span> = int64</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-context_id_t"><a href="#val-context_id_t" class="anchor"></a><code><span><span class="keyword">val</span> context_id_t : <span>int64 <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-add"><a href="#type-add" class="anchor"></a><code><span><span class="keyword">type</span> add</span><span> = <a href="V0/index.html#type-add">V0.add</a></span><span> = </span><span>{</span></code><ol><li id="type-add.key" class="def record field anchored"><a href="#type-add.key" class="anchor"></a><code><span>key : <a href="#type-key">key</a>;</span></code></li><li id="type-add.value" class="def record field anchored"><a href="#type-add.value" class="anchor"></a><code><span>value : string;</span></code></li><li id="type-add.in_ctx_id" class="def record field anchored"><a href="#type-add.in_ctx_id" class="anchor"></a><code><span>in_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></li><li id="type-add.out_ctx_id" class="def record field anchored"><a href="#type-add.out_ctx_id" class="anchor"></a><code><span>out_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_t"><a href="#val-add_t" class="anchor"></a><code><span><span class="keyword">val</span> add_t : <span><a href="#type-add">add</a> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-copy"><a href="#type-copy" class="anchor"></a><code><span><span class="keyword">type</span> copy</span><span> = <a href="V0/index.html#type-copy">V0.copy</a></span><span> = </span><span>{</span></code><ol><li id="type-copy.key_src" class="def record field anchored"><a href="#type-copy.key_src" class="anchor"></a><code><span>key_src : <a href="#type-key">key</a>;</span></code></li><li id="type-copy.key_dst" class="def record field anchored"><a href="#type-copy.key_dst" class="anchor"></a><code><span>key_dst : <a href="#type-key">key</a>;</span></code></li><li id="type-copy.in_ctx_id" class="def record field anchored"><a href="#type-copy.in_ctx_id" class="anchor"></a><code><span>in_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></li><li id="type-copy.out_ctx_id" class="def record field anchored"><a href="#type-copy.out_ctx_id" class="anchor"></a><code><span>out_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-copy_t"><a href="#val-copy_t" class="anchor"></a><code><span><span class="keyword">val</span> copy_t : <span><a href="#type-copy">copy</a> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-commit"><a href="#type-commit" class="anchor"></a><code><span><span class="keyword">type</span> commit</span><span> = <a href="V0/index.html#type-commit">V0.commit</a></span><span> = </span><span>{</span></code><ol><li id="type-commit.hash" class="def record field anchored"><a href="#type-commit.hash" class="anchor"></a><code><span>hash : <span><a href="#type-hash">hash</a> <a href="#type-scope">scope</a></span>;</span></code></li><li id="type-commit.date" class="def record field anchored"><a href="#type-commit.date" class="anchor"></a><code><span>date : int64;</span></code></li><li id="type-commit.message" class="def record field anchored"><a href="#type-commit.message" class="anchor"></a><code><span>message : <a href="#type-message">message</a>;</span></code></li><li id="type-commit.parents" class="def record field anchored"><a href="#type-commit.parents" class="anchor"></a><code><span>parents : <span><span><a href="#type-hash">hash</a> <a href="#type-scope">scope</a></span> list</span>;</span></code></li><li id="type-commit.in_ctx_id" class="def record field anchored"><a href="#type-commit.in_ctx_id" class="anchor"></a><code><span>in_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-commit_t"><a href="#val-commit_t" class="anchor"></a><code><span><span class="keyword">val</span> commit_t : <span><a href="#type-commit">commit</a> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-row"><a href="#type-row" class="anchor"></a><code><span><span class="keyword">type</span> row</span><span> = <a href="V0/index.html#type-row">V0.row</a></span><span> = </span></code><ol><li id="type-row.Checkout" class="def variant constructor anchored"><a href="#type-row.Checkout" class="anchor"></a><code><span>| </span><span><span class="constructor">Checkout</span> <span class="keyword">of</span> <span><a href="#type-hash">hash</a> <a href="#type-scope">scope</a></span> * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></li><li id="type-row.Add" class="def variant constructor anchored"><a href="#type-row.Add" class="anchor"></a><code><span>| </span><span><span class="constructor">Add</span> <span class="keyword">of</span> <a href="#type-add">add</a></span></code></li><li id="type-row.Remove" class="def variant constructor anchored"><a href="#type-row.Remove" class="anchor"></a><code><span>| </span><span><span class="constructor">Remove</span> <span class="keyword">of</span> <a href="#type-key">key</a> * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span> * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></li><li id="type-row.Copy" class="def variant constructor anchored"><a href="#type-row.Copy" class="anchor"></a><code><span>| </span><span><span class="constructor">Copy</span> <span class="keyword">of</span> <a href="#type-copy">copy</a></span></code></li><li id="type-row.Find" class="def variant constructor anchored"><a href="#type-row.Find" class="anchor"></a><code><span>| </span><span><span class="constructor">Find</span> <span class="keyword">of</span> <a href="#type-key">key</a> * bool * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></li><li id="type-row.Mem" class="def variant constructor anchored"><a href="#type-row.Mem" class="anchor"></a><code><span>| </span><span><span class="constructor">Mem</span> <span class="keyword">of</span> <a href="#type-key">key</a> * bool * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></li><li id="type-row.Mem_tree" class="def variant constructor anchored"><a href="#type-row.Mem_tree" class="anchor"></a><code><span>| </span><span><span class="constructor">Mem_tree</span> <span class="keyword">of</span> <a href="#type-key">key</a> * bool * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></li><li id="type-row.Commit" class="def variant constructor anchored"><a href="#type-row.Commit" class="anchor"></a><code><span>| </span><span><span class="constructor">Commit</span> <span class="keyword">of</span> <a href="#type-commit">commit</a></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-row_t"><a href="#val-row_t" class="anchor"></a><code><span><span class="keyword">val</span> row_t : <span><a href="#type-row">row</a> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div></details></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></summary><div class="odoc-spec"><div class="spec value anchored" id="val-decode_i32"><a href="#val-decode_i32" class="anchor"></a><code><span><span class="keyword">val</span> decode_i32 : <span>int32 <span class="xref-unresolved">Repr</span>.decode_bin</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encode_i32"><a href="#val-encode_i32" class="anchor"></a><code><span><span class="keyword">val</span> encode_i32 : <span>int32 <span class="xref-unresolved">Repr</span>.encode_bin</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encode_lheader"><a href="#val-encode_lheader" class="anchor"></a><code><span><span class="keyword">val</span> encode_lheader : <span>unit <span class="xref-unresolved">Repr</span>.encode_bin</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encode_lrow"><a href="#val-encode_lrow" class="anchor"></a><code><span><span class="keyword">val</span> encode_lrow : <span><a href="V0/index.html#type-row">V0.row</a> <span class="xref-unresolved">Repr</span>.encode_bin</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-magic"><a href="#val-magic" class="anchor"></a><code><span><span class="keyword">val</span> magic : <span class="xref-unresolved">Irmin_traces__Trace_common.Magic.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_with_prefix_exn"><a href="#val-read_with_prefix_exn" class="anchor"></a><code><span><span class="keyword">val</span> read_with_prefix_exn : 
  <span><span>(<span>string <span class="arrow">&#45;&gt;</span></span> <span><span>int <span class="xref-unresolved">Stdlib</span>.ref</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Stdlib</span>.in_channel <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-decoded_seq_of_encoded_chan_with_prefixes"><a href="#val-decoded_seq_of_encoded_chan_with_prefixes" class="anchor"></a><code><span><span class="keyword">val</span> decoded_seq_of_encoded_chan_with_prefixes : 
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Repr</span>.ty</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Stdlib</span>.in_channel <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib__Seq</span>.node</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-open_reader"><a href="#val-open_reader" class="anchor"></a><code><span><span class="keyword">val</span> open_reader : <span>string <span class="arrow">&#45;&gt;</span></span> unit * <span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><a href="V0/index.html#type-row">V0.row</a> <span class="xref-unresolved">Stdlib__Seq</span>.node</span>)</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-writer"><a href="#type-writer" class="anchor"></a><code><span><span class="keyword">type</span> writer</span><span> = </span><span>{</span></code><ol><li id="type-writer.path" class="def record field anchored"><a href="#type-writer.path" class="anchor"></a><code><span>path : string;</span></code></li><li id="type-writer.channel" class="def record field anchored"><a href="#type-writer.channel" class="anchor"></a><code><span>channel : <span class="xref-unresolved">Stdlib</span>.out_channel;</span></code></li><li id="type-writer.buffer" class="def record field anchored"><a href="#type-writer.buffer" class="anchor"></a><code><span>buffer : <span class="xref-unresolved">Stdlib</span>.Buffer.t;</span></code></li></ol><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create_file"><a href="#val-create_file" class="anchor"></a><code><span><span class="keyword">val</span> create_file : <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="#type-writer">writer</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-append_row"><a href="#val-append_row" class="anchor"></a><code><span><span class="keyword">val</span> append_row : <span><a href="#type-writer">writer</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="V0/index.html#type-row">V0.row</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-flush"><a href="#val-flush" class="anchor"></a><code><span><span class="keyword">val</span> flush : <span><a href="#type-writer">writer</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-writer">writer</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span><span class="keyword">val</span> remove : <span><a href="#type-writer">writer</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div></details></div></div></body></html>